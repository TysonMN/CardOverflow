@page "/gromplateinstance/{InstanceId:int}"

@using Microsoft.AspNetCore.Mvc
@using Microsoft.FSharp.Collections
@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using CardOverflow.Sanitation
@using CardOverflow.Server.Data
@using Microsoft.AspNetCore.WebUtilities
@using ThoughtDesign.WebLibrary
@inject NavigationManager NavigationManager
@inject IToastService ToastService
@inject DbExecutor DbExecutor

@if (Instance == null) {
  <p><em>@_loadingMessage</em></p>
} else {
  <div class="row">
    <div class="col-sm">
      <EditForm Model=@Instance OnValidSubmit=@Submit>
        <fieldset disabled=@IsDisabled>
          <div class="input-group">
            <label for="nameInput" class="col-form-label mr-2">
              Name:
            </label>
            <InputText id="nameInput" @bind-Value=@Instance.Name class="form-control mb-2" />
          </div>
          <div class="row">
            <div class="col-sm">
              <GromplateEditor_Type Instance=@Instance UpdateGromplateType=@(x => Instance.Templates = x) />
              <table class="table-borderless my-3">
                <thead>
                  <tr>
                    <th>Field Name</th>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  @foreach (var (field, i) in Instance.Fields.Select((x, i) => (x, i))) {
                    <tr>
                      <td>
                        <InputText @bind-Value=@field.Name class="form-control" />
                        <ValidationMessage For=@(() => field.Name) />
                      </td>
                      <td>
                        <button type="button" class="btn" @onclick=@(() => DeleteField(i)) disabled=@IsDisabled>
                          <span class="oi oi-trash"></span>
                        </button>
                      </td>
                    </tr>
                  }
                  <tr>
                    <td></td>
                    <td></td>
                    <td>
                      <button type="button" class="btn btn-success" @onclick=AddField disabled=@IsDisabled>
                        <span class="oi oi-plus"></span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="col-sm">
              <h5 class="text-center">CSS</h5>
              <InputTextArea @bind-Value=@Instance.Css class="form-control code" rows="25" />
              <ValidationMessage For=@(() => Instance.Css) />
            </div>
          </div>
          <GromplateEditor_Templates Instance=@Instance IsDisabled=@IsDisabled UpdateGromplateType=@(x => Instance.Templates = x) />
        </fieldset>
        <div class="mt-3">
          <div class="row">
            <div class="col"></div>
            <div class="col btn-group">
              @if (IsDisabled && Gromplate != null) {
                <h5 class="mt-2 mr-2">Revision</h5>
                <select class="form-control" @onchange=@(x => x.Value.ToString().Apply(int.Parse).Apply(id => Instance = Gromplate.Instances.Single(x => x.Id == id)))>
                  @foreach (var instance in Gromplate.Instances.OrderByDescending(x => x.Created)) {
                    <option value=@instance.Id selected=@(Instance.Id == instance.Id)>
                      @instance.EditSummary - @instance.Created
                    </option>
                  }
                </select>
                <button class="btn btn-primary" type="button" disabled=@IsDisabled @onclick=@(() => { IsDisabled = false; Instance.EditSummary = ""; })>
                  Edit
                </button>
              } else {
                <InputText @bind-Value=@Instance.EditSummary class="form-control" placeholder="Edit Summary" disabled=@IsDisabled />
                <button type="submit" class="btn btn-primary" disabled=@IsDisabled>Save</button>
              }
            </div>
          </div>
          <div class="row">
            <DataAnnotationsValidator />
            <ValidationSummary />
          </div>
        </div>
      </EditForm>
    </div>
  </div>
}
@code {
  [CascadingParameter] Task<UserClaims> UserTask { get; set; }
  private UserClaims _user = UserClaims.init;
  [Parameter] public int GromplateId { get; set; }
  [Parameter] public int InstanceId { get; set; }
  [Parameter] public bool IsDisabled { get; set; } = true;
  [Parameter] public ViewGrompleaf Instance { get; set; }
  [Parameter] public ViewGromplateWithAllInstances Gromplate { get; set; }
  private string _loadingMessage = "Loading...";

  private async Task _isChildComponent() {
    var x = (Gromplate == null || (Gromplate.Id != GromplateId && GromplateId != 0))
      ? await DbExecutor.QueryAsync(db => SanitizeGromplate.AllInstances(db, GromplateId))
      : FSharpResult<ViewGromplateWithAllInstances, string>.NewOk(Gromplate);
    if (x.IsOk) {
      Gromplate = x.ResultValue;
      Instance = Gromplate.Instances.SingleOrDefault(x => x.Id == NavigationManager.GetQueryInt("InstanceId")) ?? Gromplate.Instances.First();
    } else {
      _loadingMessage = x.ErrorValue;
      ToastService.ShowError(x.ErrorValue);
    }
  }

  private async Task _isInstancePage() {
    var x = await DbExecutor.QueryAsync(db => SanitizeGromplate.instance(db, InstanceId));
    if (x.IsOk) {
      Instance = x.ResultValue;
    } else {
      _loadingMessage = x.ErrorValue;
      ToastService.ShowError(x.ErrorValue);
    }
  }

  protected override async Task OnParametersSetAsync() {
    await base.OnParametersSetAsync();
    _user = await UserTask;
    await (InstanceId == 0
      ? _isChildComponent()
      : _isInstancePage());
    IsDisabled = Gromplate.AuthorId != _user.Id;
  }

  async Task Submit() {
    IsDisabled = true;
    var x = await DbExecutor.QueryAsync(db => SanitizeGromplate.Update(db, _user.Id, Instance));
    if (x.IsOk) {
      ToastService.ShowSuccess("Saved!");
    } else {
      ToastService.ShowError(x.ErrorValue);
      IsDisabled = false;
    }
  }

  void DeleteField(int ordinal) {
    Instance.Fields.RemoveAt(ordinal);
  }

  void AddField() {
    Instance.Fields.Add(new ViewField {
      Name = "New Field"
    });
  }

}
