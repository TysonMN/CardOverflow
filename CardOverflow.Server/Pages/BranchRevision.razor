@page "/branch/{Id:int}/revision"
@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using CardOverflow.Sanitation
@inject DbExecutor DbExecutor

@if (_revision == null) {
  <p><em>Loading...</em></p>
} else {
  <div class="text-right">
    By <a href="user/@_revision.AuthorId">@_revision.Author</a>
  </div>
  <ol class="list-group" style="list-style: decimal inside;">
    @foreach (var meta in _revision.SortedMeta) {
      <li class="list-group-item" style="display: list-item">
        <label>Created:</label> @meta.Created
        @if (meta.Modified != null) {
          <label>Modified:</label> @meta.Modified.Value;
        }
        <ResizingIframeBranch BranchInstanceId=@meta.Id MaxIndexInclusive=@meta.MaxIndexInclusive Back />
      </li>
    }
  </ol>
}

@code {
  [Parameter] public int Id { get; set; }
  [CascadingParameter] Task<UserClaims> UserTask { get; set; }
  private UserClaims _user = UserClaims.init;
  private CardOverflow.Pure.BranchRevision _revision;

  public override async Task SetParametersAsync(ParameterView parameters) {
    await base.SetParametersAsync(parameters);
    var user = await UserTask;
    _revision = await DbExecutor.QueryAsync(db => StackRepository.Revisions(db, user.Id, Id));
    StateHasChanged();
  }

}
