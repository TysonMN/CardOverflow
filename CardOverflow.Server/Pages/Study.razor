@page "/study"
@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@inject CardOverflowDb Db

@if (todaysCards == null) {
  <p><em>Loading...</em></p>
} else {
  <div class="study-content">
    @if (error == null) {
      @* https://stackoverflow.com/questions/19739001/which-is-the-difference-between-srcdoc-and-src-datatext-html-in-an/ *@
      <iframe sandbox allow-scripts class="study-iframe" srcdoc="@iframeSrcdoc"></iframe>
    } else {
      <h2>Error!</h2>
      <p>@error</p>
      <p>If you're seeing this error message, please contact support with the error message to resolve this issue.</p> @*lowTODO show a better error message*@
    }
  </div>
  <div class="study-footer">
    @if (isFront == true) {
      <button class="btn btn-primary" onclick="@ShowBack">Show answer</button>
    } else if (isFront == false) {
      <button class="btn btn-primary" onclick="@(() => SaveScore(0))">Again</button> @*medTODO show how long until this card comes back*@
      <button class="btn btn-primary" onclick="@(() => SaveScore(1))">Hard</button>
      <button class="btn btn-primary" onclick="@(() => SaveScore(2))">Good</button>
      <button class="btn btn-primary" onclick="@(() => SaveScore(3))">Easy</button>
    } else {
      <button class="btn btn-primary" onclick="@ShowNextCard">Show next card</button>
    }
  </div>
}

@code {
  string iframeSrcdoc;
  string error;
  bool? isFront;
  IList<FSharpResult<QuizCard, string>> todaysCards;

  protected override async Task OnInitAsync() {
    todaysCards = (await CardRepository.GetTodaysCards(Db, 3)).ToList(); // medTODO remove the 3
    ShowFront();
  }

  void SaveScore(int difficulty) {
    // medTODO actually save
    todaysCards.RemoveAt(0);
    ShowFront();
  }

  void ShowFront() {
    if (todaysCards.First().IsOk) {
      isFront = true;
      iframeSrcdoc = todaysCards.First().ResultValue.Question;
    } else {
      error = todaysCards.First().ErrorValue;
    }
  }

  void ShowBack() {
    isFront = false;
    iframeSrcdoc = todaysCards.First().ResultValue.Answer;
  }

  void ShowNextCard() {
    todaysCards.RemoveAt(0);
    ShowFront();
    error = null;
  }

}
