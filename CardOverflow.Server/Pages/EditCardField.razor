@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using Microsoft.FSharp.Collections
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using CardOverflow.Sanitation
@using Syncfusion.EJ2.Blazor
@using Syncfusion.EJ2.Blazor.RichTextEditor
@inject IToastService ToastService

<div class="d-flex justify-content-between">
  <label><b>@Field.EditField.Name: </b></label>
  <div class="form-check">
    <label class="form-check-label">
      <input type="checkbox" class="form-check-input" @onclick=@(() => ToggleCommunal(Field))/>
      Communal
    </label>
  </div>
  @if (Field.IsCommunal) {
    <div>
      <span>Shared with:</span>
      @foreach (var instanceId in Field.CommunalCardInstanceIds.Where(x => x != Card.CardInstanceMeta.Id)) {
        <span class="curate-tooltip-target">
          <span class="oi oi-eye" aria-hidden="true"></span>
          <div class="curate-tooltip-content">
            <ResizingIframe SrcUrl=@("/cardinstance/" + instanceId + "/front")></ResizingIframe>
          </div>
        </span>
      }
    </div>
  }
</div>
<EjsRichTextEditor @bind-Value=@Field.Value>
  @* highTODO why doesn't iFrame work? *@
  <RichTextEditorToolbarSettings Items=@Tools></RichTextEditorToolbarSettings>
</EjsRichTextEditor>
<ValidationMessage For=@(() => Field.Value) />

@code {
  [Parameter]
  public EditFieldAndValue Field { get; set; }
  [Parameter]
  public AcquiredCard Card { get; set; }
  private object[] Tools = new object[] { "Bold", "Italic", "Underline", "SubScript", "SuperScript", "StrikeThrough", "FontName", "FontSize", "FontColor", "BackgroundColor", "|", "Formats", "Alignments", "OrderedList", "UnorderedList", "Outdent", "Indent", "|", "CreateTable", "CreateLink", "Image", "|", "ClearFormat", "SourceCode", "FullScreen", "|", "Undo", "Redo" };

  void ToggleCommunal(EditFieldAndValue pair) {
    pair.Communal = pair.CommunalCardInstanceIds.Append(Card.CardInstanceMeta.Id).ToList().Apply(x => new CommunalFieldValue(x)); // highTODO new ones append 0, which needs to be handled
  }

}
