
@page "/cardoption"
@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using CardOverflow.Sanitation
@using CardOverflow.Server.Data
@inject DbExecutor DbExecutor
@inject IToastService ToastService

@if (User == null) {
  <span>You need to log in dude.</span>
} else if (_options == null) {
  <p><em>Loading...</em></p>
} else {
  <div class="row">
    <div class="col-sm-10">
      <CardOptionEditorDetail Option=@_selected Save=@Save SetAsDefault=@_SetSelectedAsDefault />
    </div>
    <div class="col-sm-2 list-group">
      <h5>Card Options</h5>
      <button type="button" class="btn btn-success" @onclick=@_Add>
        Add
      </button>
      <button type="button" class="btn btn-primary" @onclick=@Save>Save</button>
      @foreach (var x in _options.Select((x, i) => new { Option = x, Index = i })) {
        <button class="list-group-item list-group-item-action @(_selected == x.Option ? "active" : "")"
                @onclick=@(() => _Select(x.Index))>
          @if (x.Option.IsDefault) {
            <span class="oi oi-star"></span>
          }
          @x.Option.Name
        </button>
      }
    </div>
  </div>
}

@code {
  [CascadingParameter]
  public UserEntity User { get; set; }
  private List<ViewCardOption> _options;
  private ViewCardOption _selected;

  protected override async Task OnInitializedAsync() {
    if (User != null) {
      _options = await DbExecutor.QueryAsync(db => SanitizeCardOptionRepository.getAll(db, User.Id));
      _selected = _options.Single(x => x.IsDefault);
    }
  }

  private void _Select(int index) =>
    _selected = _options.ElementAt(index);

  private void _Add() {
    var option = CardOptionsRepository.defaultCardOptions.Apply(ViewCardOption.load);
    option.Name = "New Card Options";
    option.IsDefault = false;
    _options.Add(option);
    _selected = option;
  }

  private void _SetSelectedAsDefault() {
    _options.Single(x => x.IsDefault).IsDefault = false;
    _selected.IsDefault = true;
  }

  private async Task Save() {
    var r = await DbExecutor.QueryAsync(db => SanitizeCardOptionRepository.upsertMany(db, User.Id, _options));
    if (r.IsOk) {
      if (r.ResultValue.Count() == _options.Count()) {
        foreach (var x in r.ResultValue.Select((id, i) => new { NewId = id, Index = i })) {
          _options.ElementAt(x.Index).Id = x.NewId;
        }
      } else {
        throw new Exception("Response doesn't have the correct number of CardOptions");
      }
      ToastService.ShowInfo("Saved!");
    } else {
      ToastService.ShowError(r.ErrorValue);
    }
  }

}
