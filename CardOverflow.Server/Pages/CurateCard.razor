@page "/Curate/Card/{Id:int}"
@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using CardOverflow.Sanitation
@using Syncfusion.EJ2.Blazor
@using Syncfusion.EJ2.Blazor.RichTextEditor
@inject IToastService ToastService
@inherits OwningComponentBase<CardOverflowDb>
@*medTODO add "next" and "previous" navigation buttons that move up/down the list, and it'll need to remember the search parameters*@

@if (Card == null) {
  <p><em>@LoadingMessage</em></p>
} else {
  <EditForm Model="@EditCard" OnValidSubmit="@UpdateCard">
    <fieldset disabled=@IsSaved>
      <div class="form-group">
        <div class="row">
          <div class="col-sm">
            @foreach (var field in EditCard.View.FieldValues) {
              <label><b>@field.Field.Name: </b></label>
              <EjsRichTextEditor @bind-Value=@field.Value>
                @* highTODO why doesn't iFrame work? *@
                <RichTextEditorToolbarSettings Items=@Tools></RichTextEditorToolbarSettings>
              </EjsRichTextEditor>
            }
          </div>
          <div class="col-sm">
            <a href="CardTemplate/@EditCard.View.TemplateInstance.CardTemplateId?InstanceId=@EditCard.View.TemplateInstance.Id">Card Template Instance</a>
            <ResizingIframe SrcUrl=@("/cardinstance/" + Card.CardInstanceMeta.Id + "/back") />
            Tags:
            <ul>
              @foreach (var tag in Card.Tags) {
                <li>
                  @tag
                </li>
              }
            </ul>
          </div>
        </div>
      </div>
      <div class="float-right">
        <div class="row">
          <span class="btn-group">
            <InputText @bind-Value=@EditCard.EditSummary class="form-control" placeholder="Edit Summary" style="width: 500px;" />
            <button type="submit" class="btn btn-primary">Save</button>
          </span>
        </div>
        <div class="row">
          <DataAnnotationsValidator />
          <ValidationSummary />
        </div>
      </div>
    </fieldset>
  </EditForm>
}

@code {
  private object[] Tools = new object[] { "Bold", "Italic", "Underline", "SubScript", "SuperScript", "StrikeThrough", "FontName", "FontSize", "FontColor", "BackgroundColor", "|", "Formats", "Alignments", "OrderedList", "UnorderedList", "Outdent", "Indent", "|", "CreateTable", "CreateLink", "Image", "|", "ClearFormat", "SourceCode", "FullScreen", "|", "Undo", "Redo" };
  AcquiredCard Card;
  EditCardCommand EditCard;
  [Parameter]
  public int Id { get; set; }
  [CascadingParameter]
  UserEntity User { get; set; }
  string LoadingMessage = "Loading...";
  bool IsSaved;

  protected override async Task OnInitializedAsync() {
    var x = await CardRepository.GetAcquired(Service, User?.Id ?? 0, Id);
    if (x.IsOk) {
      Card = x.ResultValue;
      EditCard = await SanitizeCardRepository.getEdit(Service, Card.CardInstanceMeta.Id);
    } else {
      LoadingMessage = x.ErrorValue;
      ToastService.ShowError(x.ErrorValue);
    }
  }

  async Task UpdateCard() {
    var result = SanitizeCardRepository.Update(Service, User.Id, Card, EditCard);
    if (result.IsOk) {
      await result.ResultValue;
      ToastService.ShowInfo("Saved!");
      IsSaved = true;
    } else {
      ToastService.ShowError(result.ErrorValue);
    }
  }

}
