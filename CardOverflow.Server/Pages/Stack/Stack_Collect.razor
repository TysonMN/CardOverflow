@using Microsoft.FSharp.Core
@using CardOverflow.Entity
@using CardOverflow.Debug
@using CardOverflow.Pure
@using CardOverflow.Api
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using CardOverflow.Sanitation
@using CardOverflow.Server.Data
@inject DbExecutor DbExecutor
@inject IToastService ToastService
@inject UserContentHttpClient UserContentHttpClient
@inject TimeProvider TimeProvider

<div>
  <div class="d-flex">
    <strong class="my-2">
      Setting:&nbsp;
    </strong>
    <CardSettingSelector SettingSelected=_SetSetting SelectedId=@CollectedCard.CardSettingId />
  </div>
  <div class="d-flex">
    <strong class="my-2">
      Deck:&nbsp;
    </strong>
    <DeckSelector DeckSelected=_SetDeck SelectedId=@CollectedCard.DeckId />
  </div>
  <div class="d-flex justify-content-between">
    <div>
      <strong>
        Due:
      </strong>
      <span title=@(CollectedCard.Due + "UTC")>
        <Due DueDate=@CollectedCard.Due />
      </span>
    </div>
    @if (!_showAdvanced) {
      <button class="btn" @onclick=@(() => _showAdvanced = true)>
        <i class="fas fa-ellipsis-h"></i>
      </button>
    }
  </div>
  @if (_showAdvanced) {
    <div>
      <strong>
        State:
      </strong>
      @CollectedCard.CardState
    </div>
    <div>
      <strong>
        Is Lapsed:
      </strong>
      @CollectedCard.IsLapsed
    </div>
    <div>
      <strong>
        Ease Factor:
      </strong>
      @(CollectedCard.EaseFactorInPermille * 10)%
    </div>
    <div>
      @if (CollectedCard.CardState.IsSuspended) {
        <button class="btn btn-primary" @onclick=@(() => _editState(CardState.Normal))>
          Unsuspend
        </button>
      } else {
        <button class="btn btn-outline-primary" @onclick=@(() => _editState(CardState.Suspended))>
          Suspend
        </button>
      }
    </div>
  }
</div>

@code {
  [CascadingParameter] Task<UserClaims> UserTask { get; set; }
  [Parameter] public CollectedCard CollectedCard { get; set; }
  [Parameter] public EventCallback<(int, CardState)> CardStateUpdated { get; set; }
  private bool _showAdvanced;

  private async Task _SetSetting(int newId) {
    var user = await UserTask;
    var r = await DbExecutor.QueryAsync(db => SanitizeCardSettingRepository.setCard(db, user.Id, CollectedCard.CollectedCardId, newId));
    if (r.IsOk) {
      ToastService.ShowInfo("Card setting saved!");
    } else {
      ToastService.ShowError(r.ErrorValue);
    }
  }

  private async Task _SetDeck(int newId) {
    var user = await UserTask;
    await DbExecutor.QueryAsync(db => SanitizeDeckRepository.@switch(db, user.Id, newId, CollectedCard.CollectedCardId))
      .Match(ToastService, _ => ToastService.ShowInfo("Deck saved!"));
  }

  private async Task _editState(CardState state) {
    var user = await UserTask;
    await DbExecutor.QueryAsync(db => StackRepository.editState(db, user.Id, CollectedCard.CollectedCardId, state)).Match(ToastService, async _ =>
      await CardStateUpdated.InvokeAsync((CollectedCard.Index, state)
    ));
  }

}
